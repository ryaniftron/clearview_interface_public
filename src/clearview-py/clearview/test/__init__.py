import logging

import clearview
from clearview.comspecs import clearview_specs, cv_device_limits, band_map_cv_to_display, band_map_display_to_cv
import requests

from time import sleep

logger = logging.getLogger(__name__)

class SerialTest:
    def __init__(self):
        self.cv = clearview.ClearView(
                port="/dev/ttyUSB0",    # port name, COMX on windows
                debug=False,
                # Slows stuff down. TODO not implemented well yet
                robust=False,            # checks all data sent was actually received
                timeout=0.1,            # serial read timeout
                simulate_serial_port=False,
                return_formatted_commands=False,
            )

        # test_automated(cv)
        self.test_manual()



    # This module is for testing the CV2.0 protocol for both automated and manual tests

    def test_manual(self):

        #TODO in the raw input, you could generate a report based on pass or fail

        rx_id = clearview_specs["bc_id"]

        # # Antenna Mode
        # ams = ['DIVERSITY', 'LEFT', 'RIGHT', 'CLEARVIEW']
        # for i, am in enumerate(ams):
        #     self.cv.set_antenna_mode(rx_id, i)
        #     raw_input("Check Antenna Mode: %s:%s"%(i, am)) # Python2 only

        # # Band Channel
        # for bc in range(cv_device_limits["min_channel"], cv_device_limits["max_channel"] + 1):
        #     self.cv.set_band_channel(rx_id, bc)
        #     raw_input("Check Channel: %s"%(bc))

        # # band groups
        # for bg, bname in band_map_cv_to_display.items():
        #     self.cv.set_band_group(rx_id, bg)
        #     raw_input("Check Band: %s=>%s"%(bg,bname))

        # Set CV to R8 for further tests (ALWAYS)
        self.cv.set_band_channel(rx_id, 7)
        self.cv.set_band_group(rx_id, band_map_display_to_cv['R'])



        # # User ID String
        # for osd_str in ["UPPERCASE", "lowercase", "3P$ia(", "MyReallyLongOSDString",""]:
        #     self.cv.set_osd_string(rx_id, osd_str)
        #     if osd_str == '':
        #         print("Turning off ID")
        #     raw_input("Check OSD String is '%s'"%(osd_str))


        # # Mode for showing live, menu, or spectrum
        # mode_seq = ["live", "menu", "spectrum", "live", "spectrum", "menu", "live"]
        # for mode in mode_seq:
        #     self.cv.set_video_mode(rx_id, mode)
        #     raw_input("Check video display mode to %s"% mode)


        # # OSD enable disable
        # self.cv.show_osd(rx_id)
        # raw_input("Check CV OSD visible")


        # self.cv.hide_osd(rx_id)
        # raw_input("Check CV OSD hidden")


        # self.cv.show_osd(rx_id)
        # raw_input("Check CV OSD visible")

        # # OSD Position
        # for i in range(cv_device_limits["min_osd_position"], cv_device_limits["max_osd_position"] + 1):
        #     self.cv.set_osd_at_predefined_position(rx_id,i)
        #     raw_input("Check osd in position %s"%i)
        # Move back to reasonable position
        self.cv.set_osd_at_predefined_position(rx_id,1)

        # for i in range(2): # Test a few times
        #     self.cv.reset_lock(rx_id)
        #     raw_input("Check lock was reset")

        # Show the menu now to check the camera type changes
        self.cv.set_video_mode(rx_id, "menu")

        # for vf in cv_device_limits["video_format_list"]:
        #     self.cv.set_video_format(rx_id, vf)
        #     raw_input("Check video format is %s"%vf)

        self.cv.set_video_format(rx_id,"N")

        self.cv.move_cursor(rx_id,'down')
        raw_input("Check moved down")

        self.cv.move_cursor(rx_id,'up')
        raw_input("Check moved up")

        self.cv.move_cursor(rx_id,'up')
        raw_input("Check moved up again")

        self.cv.move_cursor(rx_id, 'enter')

















    def test_automated(self,cv):
        bc_id = clearview_specs["bc_id"]

        # Set the receiver to addr 5
        desired_addr = 5
        self.cv.set_address(bc_id,desired_addr)
        sleep(0.2)
        try:
            new_addr = self.cv.get_address(bc_id).address
            assert int(desired_addr) == int(new_addr), "Set addr error: %s != %s"%(desired_addr, new_addr)
        except AssertionError:
            pass


        # Tell a different receiver to be addr 6 and check it's still 5
        ignore_addr = 6
        self.cv.set_address(3,ignore_addr)
        sleep(0.2)
        try:
            new_addr = self.cv.get_address(bc_id).address
            assert int(5) == int(new_addr), "Set addr error: %s != %s. Receiver shouldn't change"%(desired_addr, new_addr)
        except AssertionError:
            pass





        # self.cv.set_antenna_mode(bc_id, 5)
        # self.cv.hide_osd(bc_id)
        # sleep(1)
        # self.cv.set_all_osd_message("Hello World")
        # sleep(1)
        # self.cv.show_osd(bc_id)
        # sleep(1)
        # self.cv.set_all_osd_message(" ")



class SocketTest:
    def __init__(self, ip="192.168.4.1"):
        self.ip = ip
        self.uri = "http://" + self.ip + "/settings"
        logger.setLevel(logging.INFO)

    def send_cstm(self, cmd):
        r = requests.post(self.uri, json={"send_cmd": cmd})
        print(r.request.body.decode("UTF-8"))

    def run_post_kv(self,k,v):
        r = requests.post(self.uri, json={k: v})
        # r = requests.get('https://api.github.com/events')
        return r.json()




































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    def run_post_j(self,j):
        r = requests.post(self.uri, json=j)
        return r.json()

    def output_test_result(self, r, k=None,v=None,j=None):
        if k and v:
            logger.info("Success: {%s:%s}"

            
            %(k,v)) if r is True else logger.warning("Fail: {%s:%s} because %s"%(k,v,r))
        elif j:
            logger.info("Success: %s"%(j)) if r else logger.warning("Fail: %s"%(j))

    def test_post(self,k=None,v=None,j=None):
        if k and v:
            res = self.run_post_kv(k,v)
            pass_test = {k:v} == res
        elif j:
            res = self.run_post_j(j)
            pass_test = j == res
        else:
            raise AttributeError("Need k,v or j")

        ret = pass_test if pass_test else res
        self.output_test_result(ret, k, v, j)
        return ret




def test_st():
    st = SocketTest()
    print(st.test_post(k="band",v="1"))
    st.send_cstm("BC0")



if __name__ == "__main__":
    logging.basicConfig()
    test_st()





